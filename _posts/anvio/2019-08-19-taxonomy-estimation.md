---
layout: post
authors: [quentin,meren]
title: "Estimate taxonomy in Anvi'o"
excerpt: "Tutorial for taxonomy estimation. Setup data to estimation"
modified: 2019-08-19
tags: [tutorial, taxonomy]
categories: [anvio]
comments: true

---

{% include _toc.html %}

{:.notice}
This tutorial was written using anvi'o `v6`.


Taxonomy estimation,
* **Single Copy Core Genes**
* **presence in metagenomes** 
* **Bins**

## Introduction

With the [anvi'o](https://peerj.com/articles/1319/) you can place genome from microbial metagenome in to the tree of life.
thanks to anvi'o's ability to detect Single Copy Genes with HMM profiling, we are now able to estimate the taxonomy of each of these genes by comparing them to the life trees generated by [Genome Taxonomy DataBase]({https://gtdb.ecogenomic.org/}).


 anvi'o taxonomy estimation is composed of two main steps:

* Taxonomy assignation of single copy core genes `anvi-run-scg-taxonomy`.

* Return taxonomy estimation `anvi-estimate-taxonomy`.


And three optional to generate data used when assigning taxonomy, which is already done but can be customized:

* Download data from GTDB `anvi-setup-scgs`

* Filter and generate data use for aligment `anvi-make-scgs-database`

* Get threshold value for assigantion to a taxon `anvi-threshold-taxonomy`

### Dependencies

Even if you have a complete installation of anvi'o, the pangenomic workflow uses some additional software that may not be installed on your system.

* DIAMOND 

{:.warning}
**Citation**: If you use the [anvi'o](https://peerj.com/articles/1319/) taxonomy estimation for your research, please consider citing . Thank you for your consideration.

## Before you start



### Upgrade your database version.

``` bash
$ anvi-migrate-db CONTIGS.db
```


#### if it wasn't done before
``` bash
$  anvi-run-hmms -c contigs.db -I Bacteria_71
```
taxonomy estimation uses the results of hmm profiling, it is only necessary to profile avoire with the Bacteria 71 collection


## taxonomy assignment


The taxonomic estimation is a two-step process.


### Alignement SCGs

the first steps consists in aligning the sequences of the Single copy core genes detected by HMMer.

``` bash
$ anvi-diamond-for-taxonomy -c contigs.db
```


Note that the program will use only two CPU and threats by default, especially if you have multiple of them available to you, you should use the --num-threads and --num-core-by-threads parameter. It significantly improves the runtime. --num-core-by-threads will be the number of core allow for diamond's alignment. --num-threads will be the number of alignment running at the same time.

For example, if you have 20 cores available, you can do :


``` bash
$ anvi-diamond-for-taxonomy -c contigs.db -T 4 --num-process 5
 ```

## Taxonomy estimation

### Taxonomy estimation by SCGs

for this second and last step the will return a estimation base on genes taxonomy, it could return estimation on genes, bins, metagenomes. 


####Taxonomy estimation genes

``` bash
$ anvi-estimate-taxonomy -c contigs.db \
                          --get-taxonomy-by-scg \
                          -o output.txt
```

#### Taxonomy estimation metagenome

``` bash
$ anvi-estimate-taxonomy -c contigs.db \
                          --metagenome \
                          -o output.txt
```

####Taxonomy estimation Bins

``` bash
$ anvi-estimate-taxonomy -c contigs.db \
                          -p PROFILE.db \
                          -C default \
                          -o output.ttx
```




### Setup data for taxonomy estimation (facultatif)

#### Download data form [GTDB]({https://gtdb.ecogenomic.org/})

This commande will download multi-sequence aligment of Single copy core genes of genomes and there taxonomy from GTDB and merge then.
If no path is passe in argument the data will be download in anvio/data/misc directory.

``` bash
$ anvi-setup-scgs 
```

#### SCGs aligment files

if you want add your your personnal data you have to merge your taxonomy with ACCESSION_TO_TAXONOMY.txt on same format and add your multisequence aligment file in to the anvio/data/misc/SCGs/msa_individual_genes directory.

you need to have fasta file of hmm from anvi'o HMM profiling.

``` bash
$ anvi-make-scgs-database --hmms Bacteria_71
```

#### Threslod values


This step is particulary long and will be really long to do it on laptop. (more than 2 day with 40 core)

``` bash
$ anvi-threshold-taxonomy
```
